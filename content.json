{"pages":[],"posts":[{"title":"æ‰‹å‹•å»ºç«‹ Google ã€ Facebook ç¬¬ä¸‰æ–¹ç™»å…¥","text":"å‰é™£å­é‡åˆ°å®¢æˆ¶åæ‡‰ Facebookã€Google ç¬¬ä¸‰æ–¹ç™»å…¥ API åœ¨ instagram ã€ Line ç­‰å…§å»ºç€è¦½å™¨(in-app browser) ç„¡ç—•ç€è¦½æ¨¡å¼ ç„¡æ³•ä½¿ç”¨çš„å•é¡Œï¼ŒèŠ±äº†ä¸€æ®µæ™‚é–“ç³¾çµè·Ÿè§£æ±ºQQã€‚æ„å¤–å­¸äº†å¾ˆå¤šä»¥å‰ä¸çŸ¥é“çš„æ±è¥¿ï¼Œè¨˜éŒ„ä¸€ä¸‹ï¼ åŸå…ˆçš„åšæ³•åˆ©ç”¨ Facebookã€Google æä¾›çš„ API ï¼Œä½¿ç”¨èµ·ä¾†å¾ˆå–®ç´”ï¼šé–‹å•Ÿæ–°åˆ†é ï¼Œä½¿ç”¨è€…å®Œæˆç™»å…¥æµç¨‹å¾Œå›å‚³è³‡æ–™çµ¦åŸå…ˆçš„é é¢ä¸¦è‡ªå‹•é—œé–‰ã€‚ ğŸ¤¯ in-app browser çš„å•é¡Œï¼š é–‹å•Ÿæ–°åˆ†é é€™é¡ç€è¦½å™¨å¤§å¤š æ²’æœ‰åˆ†é åŠŸèƒ½ï¼Œæœƒç›´æ¥åœ¨åŒä¸€é åšåˆ‡æ›ã€‚åŸå…ˆç­‰å¾…å›å‚³çš„é‚£é å°±æ¶ˆå¤±äº†ï¼Œä¹Ÿå°±ç„¡æ³•æ”¶åˆ°å›å‚³ã€‚ ğŸ¤¯ ç„¡ç—•ç€è¦½çš„å•é¡Œï¼š cookie è¢«é˜»æ“‹Safari å’Œ Chrome çš„è¡¨ç¾ä¸å¤ªä¸€æ¨£ã€‚Safari ï¼ˆ14.0.3ï¼‰æ²’å•é¡Œï¼Œä½† Chrome æœƒæ“‹ cookie é€²è€Œå½±éŸ¿åˆ°è‡ªå®¶çš„ç™»å…¥API (å‚»çœ¼) chrome ç„¡ç—•æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ gapi.auth2.init æ–¹æ³•æœƒå‡ºç¾çš„error messageã€‚ æ‰‹å‹•å»ºç«‹ç™»å…¥æµç¨‹ï¼šone-page-flowä¸»è¦æ˜¯åœ¨åŒä¸€é é¢åˆ©ç”¨è½‰å€çš„æ–¹å¼é€²è¡Œç™»å…¥ï¼Œä¸¦åœ¨æœ€å¾Œå°‡ç™»å…¥è³‡æ–™å¸¶åœ¨è½‰å›ç¶²å€çš„åƒæ•¸ä¸­ã€‚å¾ åŸå…ˆï¼šæŒ‰ä¸‹ç™»å…¥ â†’ é–‹å•Ÿæ–°åˆ†é  â†’ ç™»å…¥ â†’ é—œé–‰åˆ†é  â†’ åŸå…ˆç™»å…¥é æ¥æ”¶ API å›å‚³ æ”¹æˆï¼šæŒ‰ä¸‹ç™»å…¥ â†’ å‰å¾€ç™»å…¥é  â†’ ç™»å…¥ â†’ å°å›æŒ‡å®šé é¢ï¼Œè³‡æ–™å¸¶åœ¨ç¶²å€ä¸­ åªè¦è¨­å®šå¥½ ç™»å…¥é çš„ç¶²å€ å°±å·®ä¸å¤šæˆåŠŸäº†ï¼›å°å›å¾Œï¼Œä¹Ÿåªè¦åœ¨ route ä¸­å»å¢åŠ ä¸€äº›å°åƒæ•¸çš„åˆ¤æ–·ã€è™•ç†å°±å¥½äº†ã€‚ Facebookè¦ºå¾—è‡‰æ›¸å¯«çš„æ–‡ä»¶æ¯”è¼ƒå¥½æ‡‚ï¼Œå…ˆæ‹¿è‡‰æ›¸ä¾†ç•¶ç¯„ä¾‹ 123456https://www.facebook.com/v10.0/dialog/oauth? client_id={app-id} //required &amp;redirect_uri={ç™»å…¥å®Œå¾Œçš„å›å‚³å€} //required &amp;state={é˜²æ­¢è·¨ç¶²ç«™å½é€ çš„çš„å­—ä¸²ï¼Œä¹Ÿæœƒè¢«æ”¾åœ¨å›å‚³ç¶²å€ä¸­} //required &amp;response_type={å›å‚³è³‡æ–™é¡å‹} //optionalï¼Œé è¨­ç‚º code &amp;scope={ä½ è¦å‘ä½¿ç”¨è€…è¦æ±‚çš„å¸³è™Ÿæ¬Šé™} //optional Googleé™¤äº†å¯ä»¥çœ‹ JS Web Apps ï¼Œä¹Ÿå¯ä»¥ä¸€èµ·çœ‹ Mobile and Desktop Apps è£¡çš„å…§å®¹ï¼Œå¯«èµ·ä¾†è·Ÿ facebook å¹¾ä¹å®Œå…¨ä¸€æ¨£ XDï¼š 123456https://accounts.google.com/o/oauth2/v2/auth? client_id={app-id} &amp;redirect_uri=https://jyun1desu.com/login &amp;state=google &amp;response_type=code &amp;scope=email%20profile æ¯”è¼ƒéœ€è¦æ³¨æ„çš„åƒæ•¸ï¼š response_type codeï¼š è·Ÿ API ç›´æ¥å–å¾— access_token ä¸åŒï¼Œéœ€è¦èµ° server-side loginï¼šå‰ç«¯çµ¦å¾Œç«¯ code ï¼Œç”±å¾Œç«¯å»æ›å– access_tokenã€‚ tokenï¼š ç›´æ¥å–å¾— access_tokenã€‚ é›–ç„¶ç›´æ¥è¨­å®š token å¾ˆæ–¹ä¾¿ï¼Œä½†è³‡æ–™ä¸æœƒä»¥åƒæ•¸(?)ã€è€Œæ˜¯ä»¥ç¶²å€ç‰‡æ®µ(#)çš„æ–¹å¼å­˜åœ¨ã€‚è¦ºå¾—é€™æ¨£å–è³‡æ–™æœ‰é»éº»ç…©ã€ä¹Ÿæœ‰å·¥ç¨‹å¸«å»ºè­° server-side login å¾Œç«¯çš„æ¬Šé™ç®¡ç†æœƒæ¯”è¼ƒè¸å¯¦ï¼Œå°±æ±ºå®šå– code äº†ï¼ˆå¾Œç«¯äººå¾ˆå¥½ï¼‰ã€‚ redirect_uri è¦è¨˜å¾—åˆ°ç•¶åˆåœ¨ facebook developer / google cloud å»ºç«‹çš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œ æœ‰æ•ˆçš„ OAuth é‡æ–°å°å‘ URI æ–°å¢æœ‰æ•ˆç¶²å€ã€‚ä¸åœ¨åˆ—è¡¨ä¸­çš„ç¶²å€éƒ½æœƒè¢«æ“‹ä¸‹ä¾†(è·¯å¾‘ã€åƒæ•¸ä¹Ÿéƒ½è¦å¡«ä¸Š)ã€‚ å¯æ˜¯æˆ‘æƒ³é–‹å•Ÿæ–°é é¢ Ræ’‡é™¤åœ¨ in-app browser æ²’æœ‰åˆ†é åŠŸèƒ½å…ˆä¸ç†å®ƒXDï¼Œé€™å€‹æ–¹æ³•æœ€å¤§çš„ç¼ºé»æ˜¯é é¢éƒ½æœƒåœ¨åŒä¸€é è·³è½‰ï¼Œè·Ÿå¤šæ•¸ä½¿ç”¨è€…ç¿’æ…£çš„é«”é©—æ˜¯ä¸ä¸€æ¨£çš„ã€‚ä¸€é–‹å§‹æƒ³æ³•æ˜¯ï¼š in-app browser â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é ) ä¸€èˆ¬ç€è¦½å™¨ æ­£å¸¸æ¨¡å¼ â†’ ä¿ç•™ä½¿ç”¨API ç„¡ç—•æ¨¡å¼ â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é ) çµæœæ‰¾ä¸åˆ°åˆ¤æ–·ç„¡ç—•çš„å¯é æ–¹æ³•â€¦ğŸ¥² ï¼Œåªèƒ½æ”¹æˆé€™æ¨£ï¼š in-app browser â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é ) ä¸€èˆ¬ç€è¦½å™¨ â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é â‹¯â‹¯ä½†å¥½æƒ³é–‹Rï¼ï¼ï¼) æ–¼æ˜¯é–‹å§‹æƒ³è¦æ€éº¼æ¨¡æ“¬ API é–‹å•Ÿæ–°åˆ†é ã€å‚³è³‡æ–™çµ¦éš”å£åˆ†é ã€è‡ªå‹•é—œé–‰ çš„è¡Œç‚ºï¼š é–‹å•Ÿæ–°åˆ†é ï¼šç”¨ window.open() å³å¯ XD è‡ªå‹•é—œé–‰ï¼šé€™å€‹ä¹Ÿå¾ˆç°¡å–®ï¼Œç”¨ window.close() å³å¯ XD å‚³è³‡æ–™çµ¦éš”å£åˆ†é ï¼šé€™å€‹å¥½é›£RRRRRRRï¼ï¼ï¼ï¼ï¼ ç³¾çµå¥½å¹¾å¤©å¾Œï¼ˆé€£ localStorage æ­é… visibilitychangeEvent éƒ½è©¦äº†ğŸ¥²ï¼‰ï¼Œç™¼ç¾å¾ˆè®šçš„ window.postMessage()MDNçš„è§£é‡‹å¾ˆè©³ç´° ï¼Œä»¥å‰å±…ç„¶ä¸çŸ¥é“é€™å€‹ APIï¼Œæœ¬æ¬¡æœ€å¤§æ”¶ç©«ï½ï½ï½ postMessage å¯ä»¥å¯¦ç¾åŒå€‹ç€è¦½å™¨ä¸‹çš„æºé€šï¼štabé–“ã€å½ˆå‡ºè¦–çª—èˆ‡ä¸»è¦–çª—é–“ã€ç”šè‡³å’ŒåµŒå…¥çš„ iframe ä¹Ÿå¯ä»¥ï½å¤ªæ–¹ä¾¿å•¦ï¼ä½¿ç”¨èµ·ä¾†ä¹Ÿæ»¿ç›´è§€çš„ï¼š postMessage(message, targetOrigin, transfer) messageï¼šè¦å‚³é€çš„è³‡æ–™ï¼Œå¿…å¡«ã€‚ targetOriginï¼šé™åˆ¶æ¥æ”¶å°è±¡çš„ origin ï¼Œä½¿ç”¨å­—ä¸² * å‰‡ä»£è¡¨ç„¡é™åˆ¶ï¼Œå¿…å¡«ã€‚ transferï¼šçœ‹ç„¡â€¦.ä½†å¥½åƒä¸å¤ªç”¨åˆ°ã€‚ ç›£è½ä¾†è‡ªä»–æ–¹çš„ message ä¹Ÿå¾ˆç°¡å–®ï¼šwindow.addEventListener('message', callback) ç°¡æ˜“çš„ç¯„ä¾‹åœ¨æŒ‰ä¸‹ç¬¬ä¸‰æ–¹ç™»å…¥éˆ•çš„æ™‚å€™åˆ¤æ–·æ˜¯å¦æ˜¯ in-app browser trueï¼š ä¸é–‹å•Ÿæ–°é é¢ falseï¼š é–‹å•Ÿæ–°é é¢ã€ redirect_uri å¤šè¨­å®šä¸€å€‹åƒæ•¸ï¼Œåˆ¤æ–·å›ä¾†è¦åšä¸€äº›äº‹ é»æ“Šç¬¬ä¸‰æ–¹ç™»å…¥éˆ•è§¸ç™¼ openThirdPartyAuthPageï¼š 1234567891011121314151617181920212223242526272829303132const addReciveMessageListener = () =&gt; { const reciveEvent = e =&gt; { const data = e.data if(origin === window.location.origin &amp;&amp; data.code) { doSomethingToLogin(data.code) window.removeEventListener('message', reciveEvent, false); } }; window.addEventListener('message', reciveEvent, false);};const getOAuthPageURL = (platform, isWebview) =&gt; { const redirect = isWebview? '.../login' : '.../login?type=auto-close'; switch(platform) { case 'facebook': return `https:// .....&amp;redirect_uri=${redirectUri}....`; case 'google': return `https:// .....&amp;redirect_uri=${redirectUri}....`; }}const toThirdPartyOAuthPage = platform =&gt; { const isWebview = ...; //åšä¸€äº› in-app browser çš„åˆ¤æ–· const authPageURL = getOAuthPageURL(platform, isWebview); if(isWebview){ window.location.href = authPageURL; } else { addReciveMessageListener(); window.open(authPageURL); }} è¦–çª—å›åˆ° redirect_uri å¾Œï¼Œåœ¨ route ä¸­è™•ç†ç™»å…¥è¡Œç‚ºï¼š 123456789101112131415161718// routes/Login/index.jsconst { code, type, ... } = ç¶²å€çš„query;const sendDataToLoginPage = () =&gt; { const loginData = { code }; window.opener.postMessage(loginData, 'http://jyun1desu.com');}if(code) { if(type === 'auto-close') { // normal browser redirect page sendDataToLoginPage(); window.close(); } else{ // in-app browser redirect page doSomethingToLogin(code) }} æˆåŠŸçš„æ™‚å€™å¥½æ„Ÿå‹•å•Šï½ï½ï½ ğŸ‰ğŸ‰ğŸ‰ æ‰¾è³‡æ–™çš„éç¨‹ä¸­ä¹Ÿæœ‰çœ‹åˆ° Broadcast Channel API ï¼Œé›–ç„¶æ”¯æ´åº¦é‚„å¾ˆæ‚²åŠ‡ï¼Œæ„Ÿè¦ºæ˜¯èƒ½å…ˆçœ‹èµ·ä¾†çš„æ±è¥¿ã€‚æœ€å¾Œè¬è¬ hahow ï¼Œ ä¸€åº¦è¦ºå¾—è§£æ±ºä¸äº†çš„ç„¡å¾ˆå¤šå•é¡Œï¼Œå»çœ‹äº† hahow çš„ç¶²ç«™ä¹‹å¾Œæ‰ç™¼ç¾ï¼šå—¯ï¼æœç„¶æ˜¯è‡ªå·±å¤ªæ·ºã„Œ&gt;&lt;ï¼Œå°±æ˜¯æœ‰äººåšå¾—åˆ°å•Šï¼ï¼ï¼è€Œä¸”å¯«é€™ç¯‡æ–‡ç« çš„æ™‚å€™ï¼Œçªç„¶è¦ºå¾—æ˜¯ä¸æ˜¯å…¶å¯¦æ»¿ç°¡å–®çš„â‹¯â‹¯ï¼ˆä½†ç¬¬ä¸€æ¬¡ç¢°åˆ°å°±æ˜¯è¦ºå¾—å¾ˆé›£QQï¼‰ã€‚ ä»¥ä¸Šï¼å¸Œæœ›èƒ½å¹«åŠ©åˆ°æ­£åœ¨å›°æ“¾åŒæ¨£å•é¡Œçš„äºº ğŸ‰ åƒè€ƒè³‡æ–™Google OAuthFacebook OAuthpostMessage API","link":"/jyun1blog/2021/07/19/%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%85%A5/"}],"tags":[{"name":"ç¬¬ä¸‰æ–¹ç™»å…¥","slug":"ç¬¬ä¸‰æ–¹ç™»å…¥","link":"/jyun1blog/tags/%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%85%A5/"},{"name":"googleç™»å…¥","slug":"googleç™»å…¥","link":"/jyun1blog/tags/google%E7%99%BB%E5%85%A5/"},{"name":"facebookç™»å…¥","slug":"facebookç™»å…¥","link":"/jyun1blog/tags/facebook%E7%99%BB%E5%85%A5/"}],"categories":[{"name":"JavaScript","slug":"JavaScript","link":"/jyun1blog/categories/JavaScript/"}]}