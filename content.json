{"pages":[],"posts":[{"title":"Recoil: Reactå®˜æ–¹æ¨å‡ºçš„ç‹€æ…‹ç®¡ç†å·¥å…·","text":"Recoil æ˜¯ Facebook åœ¨2020æ¨å‡ºçš„ç‹€æ…‹ç®¡ç† Libraryï¼Œé‚„åœ¨å¯¦é©—éšæ®µï¼ˆä¸æ¨è–¦ç”¨åœ¨å¤§å‹å°ˆæ¡ˆï¼‰ã€‚é›–ç„¶ä¸åƒ redux æœ‰å„ç¨®ç¥å¥‡çš„ç”¨æ³•ï¼Œä½†æ¯”èµ·ä¾†å°‘äº†å¾ˆå¤šå›ºå®šçš„èªæ³•è¦å¯«ï¼Œä½¿ç”¨èµ·ä¾†å¾ˆç°¡å–®ï¼ æ ¸å¿ƒæ¦‚å¿µä¸€åœ–ä»¥è”½ä¹‹çš„æ¦‚å¿µåœ–ï¼š Recoilä¸­æœ‰å…©ç¨® shared state ï¼Œéƒ½èƒ½å¤ è¢«è¨‚é–±ã€æ›´æ–°ï¼š atomï¼š æ˜¯ shared state çš„åŸºæœ¬å–®ä½ã€‚ selectorï¼š ç‚ºä¸€ pure function ï¼Œé€éè¼¸å…¥å…¶ä»–çš„ shared state ï¼Œè¼¸å‡ºæˆéœ€è¦çš„è³‡æ–™(derived data)ã€‚åœ¨è¼¸å…¥çš„ shared state æ›´æ–°æ™‚æ‰æœƒé‡æ–°è¨ˆç®—ã€‚ åœ¨shared stateæ›´æ–°æ™‚ï¼Œåªæœ‰è¨‚é–±è©² shared state çš„å…ƒä»¶æœƒé‡æ–°æ¸²æŸ“ã€‚ atom()æ¯å€‹atoméƒ½éœ€è¦ unique key å’Œé è¨­å€¼ï¼š 12345678910const todoList = atom({ key: 'todoList', default: [{task: 'çœ‹ä¸€æœ¬æ›¸',isComplete: false}, {task: 'æ‰“æƒå®¶è£¡',isComplete: true}]});const todoListfilter = atom({ key: 'todoListfilter', default: 'default'}); åœ¨componentä¸­ï¼ŒRecoil æä¾›äº†å¹¾å€‹ API ï¼šè·ŸuseState()å¾ˆåƒï¼Œä½†æ‹¬è™Ÿå…§æ”¾å…¥çš„ä¸æ˜¯é è¨­å€¼ï¼Œæ˜¯atomã€‚ useRecoilValue()ï¼šå–å€¼1const list = useRecoilValue(todoList); useSetRecoilState()ï¼šè¨­å€¼ä½¿ç”¨é€™å€‹ hook æ™‚ï¼Œshared stateæ”¹è®Šæ™‚componentä¸æœƒé‡æ–°æ¸²æŸ“ã€‚1const setTodos = useSetRecoilState(todoList); useRecoilState()ï¼šå–å€¼åŠè¨­å€¼1const [list,setTodos] = useRecoilState(todoList) useResetRecoilState()ï¼šèƒ½å°‡atomè¨­å®šç‚ºé è¨­å€¼ï¼Œ selector()æ¯å€‹selectorä¹Ÿéƒ½éœ€è¦ unique keyï¼Œä»¥åŠgetã€set(éå¿…è¦) methodã€‚ ä»¥ todoList ç‚ºä¾‹ï¼Œæœ‰äº† todoList å’Œç›®å‰çš„ filter ç‹€æ…‹ï¼Œå°±å¯ä»¥åˆ©ç”¨selectorè¨ˆç®—ç•¶å‰é é¢è¦é¡¯ç¤ºçš„è³‡æ–™äº†ã€‚ 1234567891011121314151617181920212223242526272829const filteredTodos = selector({ key: 'filteredTodos', get: ({get}) =&gt; { const filter = get(todoListfilter); const list = get(todoList); switch (filter) { case 'done': return list.filter((item) =&gt; item.isComplete); case 'undone': return list.filter((item) =&gt; !item.isComplete); default: return list; } }, //optional set: ({get, set}, newValue) =&gt; { ... }})const TodoList = () =&gt; { const todoList = useRecoilValue(filteredTodos); return (&lt;ul&gt; {todoList.map(todo=&gt;(&lt;li&gt;{todo.task}&lt;/li&gt;))} &lt;/ul&gt;)} å–å€¼å’Œè¨­å€¼éƒ½å¯ä»¥é€égetå–å¾—å…¶ä»–shared stateçš„è³‡æ–™ã€‚ éåŒæ­¥è³‡æ–™ä¸²æ¥atomåŠselectoréƒ½å¯ä»¥åˆ©ç”¨éåŒæ­¥çš„æ–¹å¼ä¸²æ¥è³‡æ–™ï¼š 12345678910111213const userID = atom({ key: 'userID', default: null,});const userData = selector({ key: 'userData', get: ({get}) =&gt; { const id = get(userID) const response = await fetchUserData({id}); return response.data; }}) åˆ©ç”¨useRecoilValue()ç²å¾—éåŒæ­¥çš„shared stateæ™‚ï¼Œå¯ä»¥æ­é… React çš„&lt;Suspense&gt;ä½¿ç”¨ä¾†è£½ä½œè¼‰å…¥æ•ˆæœã€‚å¦‚æœä¸æƒ³ï¼ŒRecoilä¹Ÿæœ‰å¦å¤–æä¾› API : useRecoilValueLoadable() useRecoilStateLoadable() ä¸åŒæ–¼useRecoilValue()å›å‚³ERRORæˆ–æ˜¯PROMISEï¼Œé€™å…©å€‹hooksåœ¨é‡åˆ°éåŒæ­¥ä¸²æ¥æ™‚æœƒå›å‚³å«æœ‰stateã€contentçš„ç‰©ä»¶ï¼š key/å›å‚³å…§å®¹ æˆåŠŸ å¤±æ•— loading state 'hasValue' 'hasError' 'loading' content å›å‚³çš„è³‡æ–™ error object Promise familyç³»åˆ— â† è¦ºå¾—å¾ˆé…·å¯ä»¥å¸¶å…¥å¤–éƒ¨å¼•æ•¸è‡³atomã€selectorä¸­çš„é…·æ±æ±ã€‚ atomFamily()æœ‰æ™‚éœ€è¦å‹•æ…‹ç”¢ç”Ÿatomæ™‚ï¼Œå°±å¯ä»¥ä½¿ç”¨atomfamily()ã€‚å®˜æ–¹èˆ‰äº†ä¸€å€‹ä¾‹å­ä¾†è¬›è§£ä½¿ç”¨æ™‚æ©Ÿï¼š å‡è¨­ä½ åšçš„æ˜¯ä¸€å€‹UIç·¨è¼¯é é¢ï¼Œä½¿ç”¨è€…å¯ä»¥å‹•æ…‹æ–°å¢å…ƒä»¶ã€è€Œä¸”æ¯å€‹å…ƒä»¶éƒ½æœ‰è‡ªå·±çš„å¤§å°ã€é¡è‰²ã€ä½ç½®â‹¯â‹¯ç­‰ç‹€æ…‹ã€‚ é€™æ™‚ä¸èƒ½ç¢ºå®šéœ€è¦å¹¾å€‹atomï¼Œåˆä¸æƒ³æŠŠå€‹åˆ¥å…ƒä»¶çš„æ¨£å¼å…¨éƒ¨å¡é€²ä¸€å€‹atomæ™‚ï¼Œæ‡‰è©²æ€éº¼è¾¦ï½ï¼Ÿåœ¨å®˜æ–¹æ¨è–¦å½±ç‰‡ï¼ˆ9:55-12:00ï¼‰æ¨å‡ºæ™‚ï¼Œå¯èƒ½é‚„æ²’æœ‰atomfamily()é€™å€‹èªæ³•ï¼Œç‚ºäº†è§£æ±ºå•é¡Œï¼Œå¤§å”é€éå¸¶å…¥ä¸é‡è¤‡çš„å¼•æ•¸å‹•æ…‹æ–°å¢atomï¼š 123456789const itemWithId = memorize(id =&gt; atom({ key: `item${id}`, default: { color: pink, position: {0,0} }}))const CanvasElement = ({elementID}) =&gt; { const [itemData, setItemData] = useRecoilValue(itemWithId(elementID)); return (...);} ç¾åœ¨Recoilæä¾›äº†æ›´æ–¹ä¾¿çš„atomFamily()ï¼š 123456789const itemFamily = atomFamily({ key: 'item', default: {...},});const CanvasElement = ({elementID}) =&gt; { const [itemData, setItemData] = useRecoilValue(itemFamily(elementID)); return (...);} é è¨­å€¼ é™¤äº†atomèƒ½æ”¾çš„ä¹‹å¤–ï¼Œé‚„èƒ½å¤ æ”¾å¸¶æœ‰åƒæ•¸ä¸”æœ‰å›å‚³å€¼çš„functionï¼š 12345const itemFamily = atomFamily({ key: 'item', default: param =&gt; setColor(param),}); selectorFamily(options)é¡ä¼¼selector()ï¼Œä½†æ›´å¼·å¤§çš„æ˜¯èƒ½å¸¶åƒæ•¸åˆ°getã€setä¸­ã€‚ 1234567891011const selectColor = selectorFamily({ key: 'selectColor', get: param =&gt; ({get}) =&gt; { return ... ; }, set: param =&gt; ({set,get}, newValue) =&gt; { return ... ; },}); atomFamily()çš„é è¨­å€¼å¯ä»¥æ”¾functionï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨selectFamily()ï¼š 1234567const item = atomFamily({ key: â€˜itemâ€™, default: selectorFamily({ key: 'colorSelect', get: param =&gt; ({get}) =&gt; selectColor(param); }),}); åŒä¸€å€‹selectFamily()æ¥æ”¶åˆ°ç›¸åŒçš„å¼•æ•¸æ™‚ï¼Œæœƒå›å‚³ç›¸åŒçš„selectorå¯¦é«”ã€‚ æœ€å¾Œä¸€å€‹åˆ¥å¿˜äº†&lt;RecoilRoot&gt;ï¼å¯ä»¥æœ‰è¤‡æ•¸å€‹&lt;RecoilRoot&gt;å…±å­˜ï¼Œä¸æœƒäº’ç›¸å½±éŸ¿ã€‚ä½†è‹¥æœ‰å·¢ç‹€çš„&lt;RecoilRoot&gt;ï¼Œæœ€å…§å±¤æœƒè¦†è“‹å¤–å±¤ã€‚ 123456789import { RecoilRoot } from 'recoil';function App() { return ( &lt;RecoilRoot&gt; &lt;ComponentThatUsesRecoil /&gt; &lt;/RecoilRoot&gt; );} åƒè€ƒè³‡æ–™ Recoil Doc Recoil GitHub å®˜æ–¹æ¨è–¦çš„å½±ç‰‡ Redux vs Recoil Recoil - a New State Management Library for React CodeSandbox Sample","link":"/2021/07/28/recoil/"},{"title":"styled-components èƒŒå¾Œçš„é­”æ³•: Tagged template","text":"å¯«äº†ä¸€é™£å­çš„ styled-componentsï¼Œæœ€è¿‘æ‰çŸ¥é“åŸä¾†styled.tagå¾Œé¢çš„``ï¼Œå°±æ˜¯ ES6 å¸¸å¸¸åœ¨å¯«çš„é‚£å€‹ï¼ˆæ‰“çˆ†è‡ªå·±çš„ç¬¨é ­ï¼‰ï¼Œå®ƒçš„åå­—æ˜¯ backtickã€‚é™¤æ­¤ä¹‹å¤–é‚„ç™¼ç¾äº†ç¥å¥‡çš„ç”¨æ³•ï¼Œç ”ç©¶äº†ä¸€ä¸‹è¦ºå¾—å¾ˆæœ‰è¶£ï¼Œå°¤å…¶é€™ç¯‡æ–‡ç« å¯«å¾—å¾ˆè©³ç´°ï¼ˆå®˜æ–¹æ¨è–¦ï¼‰ï¼ä»¥ä¸‹æ˜¯çœ‹å®Œä¹‹å¾Œåšçš„ç´€éŒ„ï¼Œå¦‚æœç¿’æ…£çœ‹è‹±æ–‡çš„è©±å¾ˆæ¨è–¦çœ‹çœ‹åŸæ–‡ï½ å…ˆå¾æœ€ç°¡å–®çš„é–‹å§‹8ï¼ ç¯„æœ¬å­—é¢å€¼ Template Literal / Interpolated String Literalä»¥å‰è¦ç”¨å¾ˆå¤š + ä¸²èµ·ä¾†çš„æ±æ±ï¼Œç¾åœ¨åªè¦ç”¨ backticks åŠ ä¸Š ${ è®Šæ•¸åç¨± }ï¼Œæ•´å€‹å¾ˆæ¸…çˆ½ï½backticks ä¹‹é–“çš„æ–·è¡Œã€ç©ºæ ¼ç­‰ä¹Ÿéƒ½æœƒè¢«ä¿ç•™ï¼ 123456789const myFavorite = 'Lotso';const flavour = 'strawberries'// before ES6const introduceMyBearInES5 = 'My favorite bear is '+ myFavorite + ', and his tommy smells like'+ flavour +'.';// ES6const introduceMyBearInES6 = `My favorite bear is ${myFavorite}, and his tommy smells like ${flavour}.`; ${ è®Šæ•¸åç¨± } ä¸­é™¤äº†å­—ä¸²ï¼Œä¹Ÿèƒ½æ”¾å…¥å„ç¨®é‹ç®—å¼ï¼Œç”šè‡³æ˜¯å‘¼å«å‡½å¼ï¼š 12345678910111213141516const getFullName = ({firstName, lastName}) =&gt; { return `${firstName} + ${lastName}`}const President = { firstName: 'Lotso', LastName: 'Bear' height: 50,}const introducePresident = `Our President is ${getFullName(President)}. He is ${President.height &gt; 80 ? 'tall' : 'short'}. `// 'Our President is Lotso Bear. // He is short.' æ¨™ç±¤æ¨¡ç‰ˆ tagged templateæ¨™ç±¤æ¨¡æ¿æŒ‡çš„æ˜¯åœ¨å‡½å¼å¾Œæ–¹ç›´æ¥ç”¨ä¸Š backticks ï¼Œå¾ˆæœ‰è¶£çš„æ˜¯å°å‡ºä¾†çš„argumentæœƒæ˜¯é™£åˆ—ï¼ 12345678910const printSomething = (...args) =&gt; { console.log(...args)}//ä¸€èˆ¬çš„å‡½å¼printSomething('a', 'b') // 'a b'//æ¨™ç±¤æ¨¡ç‰ˆprintSomething`` // ['']printSomething`I love Lotso` // ['I love Lotso'] é›–ç„¶æœ‰é»å·®ç•°ï¼Œä½†æ˜¯å…¶å¯¦è·Ÿä¸€èˆ¬çš„å‡½å¼ç›¸å·®ä¸é ã€‚ä½†å¦‚æœæ¨¡æ¿å­—ç¬¦ä¸²ä¸­æœ‰ä½¿ç”¨åˆ° placeholder (å°±æ˜¯é‚£å€‹ç†Ÿæ‚‰çš„${...})ï¼Œå°±æœƒç™¼ç”Ÿå¾ˆç¥å¥‡çš„äº‹æƒ…ï¼ 123456789101112const myFavorite = 'Lotso';const printSomething = (...args) =&gt; { console.log(...args)}/* å‘¼å« printSomething, ä¸¦å°‡æ¨¡ç‰ˆå­—ç¬¦ä¸²ä½œç‚ºå¼•æ•¸ä»£å…¥ */printSomething(`My favorite bear is ${myFavorite}.`) // 'My favorite bear is Lotso.'/* call printSomething as a tagged template literal(æ¨™ç±¤æ¨£æ¿å­—é¢å€¼)*/printSomething`My favorite bear is ${myFavorite}.`//[&quot;My favorite bear is &quot;, &quot;.&quot;], &quot;Lotso&quot; ç•¶éä½¿ç”¨ä¸€èˆ¬ä»£å…¥çš„å½¢å¼ã€è€Œæ˜¯åœ¨ printSomething å¾Œæ–¹ä½¿ç”¨æ¨™ç±¤æ¨£æ¿å­—é¢å€¼æ™‚ï¼Œæœƒå¾—åˆ°ä¸€ Array ä½œç‚ºç¬¬ä¸€å€‹è®Šæ•¸ï¼Œç¬¬äºŒå€‹å‰‡æ˜¯placeholder myFavorite çš„å€¼ã€‚è€Œç¬¬ä¸€å€‹ Array å…§çš„å€¼çœ‹èµ·ä¾†æ˜¯ç”± myFavorite æ‰€åœ¨çš„ä½ç½®å»å€éš”çš„ å†ä¾†å¤šå¡ä¸€å€‹æ’å…¥å€¼çœ‹çœ‹ï¼š 123456789const myFavorite = 'Lotso';const flavour = 'strawberries'printSomething`My favorite bear is ${myFavorite}, and his tommy smells like ${flavour}.`;/*** [&quot;My favorite bear is &quot;, &quot;, and his tommy smells like &quot;, &quot;.&quot;] * &quot;Lotso&quot; * &quot;strawberries&quot;**/ åœ¨å›å‚³å€¼ä¸­ï¼Œç¬¬ä¸€å€‹è®Šæ•¸æœƒæ˜¯ä¸€é™£åˆ—ï¼Œå…§æœ‰éæ’å…¥å€¼çš„æ‰€æœ‰å­—ä¸²ï¼›è€Œæ’å…¥å€¼å‰‡æœƒä¾åºæ’åˆ—åœ¨å¾Œæ–¹çš„è®Šæ•¸ä¸­ã€‚å†ä¾†çœ‹ä¸€æ¬¡æ¯”è¼ƒï¼š 123456789101112const myFavorite = 'Lotso';const flavour = 'strawberries'printSomething(`My favorite bear is ${myFavorite}, and his tommy smells like ${flavour}.`) // &quot;My favorite bear is Lotso, and his tommy smells like strawberries.&quot;printSomething`My favorite bear is ${myFavorite}, and his tommy smells like ${flavour}.`;/*** [&quot;My favorite bear is &quot;, &quot;, and his tommy smells like &quot;, &quot;.&quot;] * &quot;Lotso&quot; * &quot;strawberries&quot;**/ ç‰¹é»ä»‹ç´¹å®Œç•¢ï¼é‚£å®ƒç¥å¥‡å¥½ç”¨çš„åœ°æ–¹åœ¨å“ªè£¡å‘¢ï¼ï¼ï¼è«‹çœ‹ä»¥ä¸‹ï¼š åœ¨ styled-components ä¸­çš„å¦™ç”¨ç°¡å–®èˆ‰ä¸€å€‹ styled-components ä¸­çš„èªæ³•ï¼š 123456789const Button = styled.button` font-size: ${props =&gt; props.primary ? '2em' : '1em'};`// font-size: 2em;&lt;Button primary /&gt;// font-size: 1em;&lt;Button /&gt; å¯«èµ·ä¾†å¾ˆé †ï¼Œå¾ä¾†æ²’æƒ³éé€™æ˜¯æ€éº¼åšåˆ°çš„XDtagged template èµ·äº†ä»€éº¼ä½œç”¨ï¼Ÿ å…ˆä¾†çœ‹æ”¾å‡½å¼åœ¨æ’å…¥å€¼ä¸­æœƒå°å‡ºä»€éº¼ï¼š 123456789101112const printSomething = (...args) =&gt; { console.log(args)}printSomething(`font-size: ${(primary) =&gt; primary ? '2em' : '1em'}`)// &quot;font-size: (primary) =&gt; primary ? '2em' : '1em'&quot; &lt;- åªæ˜¯ä¸€å¨å­—ä¸²printSomething`font-size: ${(primary) =&gt; primary ? '2em' : '1em'}`/*** [&quot;font-size: &quot;, &quot;&quot;,]* (primary) =&gt; primary ? '2em' : '1em' &lt;- å¥½åƒæ˜¯å­—ä¸²åˆå¥½åƒæ˜¯å‡½å¼**/ magicï½ï½ï½é€™è£¡çš„ (primary) =&gt; primary ? '2em' : '1em' æ˜¯è²¨çœŸåƒ¹å¯¦çš„å‡½å¼ï¼ æ—¢ç„¶æ˜¯å‡½å¼ï¼Œé‚£å°±åªå‰©ä¸‹åŸ·è¡Œå®ƒé€™å€‹ä»»å‹™äº†ï¼ä¾†æ”¹å¯«ä¸€ä¸‹å¾ˆç°¡é™‹çš„ printSomethingï¼Œé †ä¾¿æ”¹åæˆ printStyles ï¼š 1234567891011121314151617181920212223242526let protoStyledComponent = { printStyles(...args) { const [literalArr, ...placeholders] = args; const styles = placeholders.reduce((result, expr, index) =&gt; { /* æœ€å¤§é‡é»ï¼šå¦‚æœæ˜¯å‡½å¼å°±åŸ·è¡Œå®ƒï¼ */ const value = typeof expr === 'function' ? expr(this.props) : expr; return result + value + literalArr[index + 1]; }, literalArr[0]); return styles; }}let component = Object.create(protoStyledComponent);component.props = { primary: true, color: 'pink' }; // å¡ä¸€äº›å‡çš„propscomponent.printStyles`font-size: ${(props) =&gt; props.primary ? '2em' : '1em'};color: ${(props)=&gt; props.color}`/*&quot;font-size: 2em;color: pink;&quot;*/ ç™»ç™»ï¼ï¼ï¼å¥½ç¥å¥‡Rï½ï½ï½çªç„¶å¤šç­è§£äº†ä¸€é»é»æ¯å¤©åœ¨å¯«çš„æ±è¥¿ï¼Œå¯«èµ·ä¾†å¥½åƒä¹Ÿæ›´é ­è…¦æ¸…æ¥šäº†ï¼å¾ŒçºŒçš„æ›´å¤šåº•å±¤è™•ç†ï¼Œå¯ä»¥çœ‹é€™ç¯‡ã€‚ åƒè€ƒè³‡æ–™The magic behind ğŸ’… styled-components","link":"/2021/07/19/tagged-template/"},{"title":"æ‰‹å‹•å»ºç«‹ Google ã€ Facebook ç¬¬ä¸‰æ–¹ç™»å…¥","text":"å‰é™£å­é‡åˆ°å®¢æˆ¶åæ‡‰ Facebookã€Google ç¬¬ä¸‰æ–¹ç™»å…¥ API åœ¨ instagram ã€ Line ç­‰å…§å»ºç€è¦½å™¨(in-app browser) ç„¡ç—•ç€è¦½æ¨¡å¼ ç„¡æ³•ä½¿ç”¨çš„å•é¡Œï¼ŒèŠ±äº†ä¸€æ®µæ™‚é–“ç³¾çµè·Ÿè§£æ±ºQQã€‚æ„å¤–å­¸äº†å¾ˆå¤šä»¥å‰ä¸çŸ¥é“çš„æ±è¥¿ï¼Œè¨˜éŒ„ä¸€ä¸‹ï¼ åŸå…ˆçš„åšæ³•åˆ©ç”¨ Facebookã€Google æä¾›çš„ API ï¼Œä½¿ç”¨èµ·ä¾†å¾ˆå–®ç´”ï¼šé–‹å•Ÿæ–°åˆ†é ï¼Œä½¿ç”¨è€…å®Œæˆç™»å…¥æµç¨‹å¾Œå›å‚³è³‡æ–™çµ¦åŸå…ˆçš„é é¢ä¸¦è‡ªå‹•é—œé–‰ã€‚ ğŸ¤¯ in-app browser çš„å•é¡Œï¼š é–‹å•Ÿæ–°åˆ†é é€™é¡ç€è¦½å™¨å¤§å¤š æ²’æœ‰åˆ†é åŠŸèƒ½ï¼Œæœƒç›´æ¥åœ¨åŒä¸€é åšåˆ‡æ›ã€‚åŸå…ˆç­‰å¾…å›å‚³çš„é‚£é å°±æ¶ˆå¤±äº†ï¼Œä¹Ÿå°±ç„¡æ³•æ”¶åˆ°å›å‚³ã€‚ ğŸ¤¯ ç„¡ç—•ç€è¦½çš„å•é¡Œï¼š cookie è¢«é˜»æ“‹Safari å’Œ Chrome çš„è¡¨ç¾ä¸å¤ªä¸€æ¨£ã€‚Safari ï¼ˆ14.0.3ï¼‰æ²’å•é¡Œï¼Œä½† Chrome æœƒæ“‹ cookie é€²è€Œå½±éŸ¿åˆ°è‡ªå®¶çš„ç™»å…¥API (å‚»çœ¼) chrome ç„¡ç—•æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ gapi.auth2.init æ–¹æ³•æœƒå‡ºç¾çš„error messageã€‚ æ‰‹å‹•å»ºç«‹ç™»å…¥æµç¨‹ï¼šone-page-flowä¸»è¦æ˜¯åœ¨åŒä¸€é é¢åˆ©ç”¨è½‰å€çš„æ–¹å¼é€²è¡Œç™»å…¥ï¼Œä¸¦åœ¨æœ€å¾Œå°‡ç™»å…¥è³‡æ–™å¸¶åœ¨è½‰å›ç¶²å€çš„åƒæ•¸ä¸­ã€‚å¾ åŸå…ˆï¼šæŒ‰ä¸‹ç™»å…¥ â†’ é–‹å•Ÿæ–°åˆ†é  â†’ ç™»å…¥ â†’ é—œé–‰åˆ†é  â†’ åŸå…ˆç™»å…¥é æ¥æ”¶ API å›å‚³ æ”¹æˆï¼šæŒ‰ä¸‹ç™»å…¥ â†’ å‰å¾€ç™»å…¥é  â†’ ç™»å…¥ â†’ å°å›æŒ‡å®šé é¢ï¼Œè³‡æ–™å¸¶åœ¨ç¶²å€ä¸­ åªè¦è¨­å®šå¥½ ç™»å…¥é çš„ç¶²å€ å°±å·®ä¸å¤šæˆåŠŸäº†ï¼›å°å›å¾Œï¼Œä¹Ÿåªè¦åœ¨ route ä¸­å»å¢åŠ ä¸€äº›å°åƒæ•¸çš„åˆ¤æ–·ã€è™•ç†å°±å¥½äº†ã€‚ Facebookè¦ºå¾—è‡‰æ›¸å¯«çš„æ–‡ä»¶æ¯”è¼ƒå¥½æ‡‚ï¼Œå…ˆæ‹¿è‡‰æ›¸ä¾†ç•¶ç¯„ä¾‹ 123456https://www.facebook.com/v10.0/dialog/oauth? client_id={app-id} //required &amp;redirect_uri={ç™»å…¥å®Œå¾Œçš„å›å‚³å€} //required &amp;state={é˜²æ­¢è·¨ç¶²ç«™å½é€ çš„çš„å­—ä¸²ï¼Œä¹Ÿæœƒè¢«æ”¾åœ¨å›å‚³ç¶²å€ä¸­} //required &amp;response_type={å›å‚³è³‡æ–™é¡å‹} //optionalï¼Œé è¨­ç‚º code &amp;scope={ä½ è¦å‘ä½¿ç”¨è€…è¦æ±‚çš„å¸³è™Ÿæ¬Šé™} //optional Googleé™¤äº†å¯ä»¥çœ‹ JS Web Apps ï¼Œä¹Ÿå¯ä»¥ä¸€èµ·çœ‹ Mobile and Desktop Apps è£¡çš„å…§å®¹ï¼Œå¯«èµ·ä¾†è·Ÿ facebook å¹¾ä¹å®Œå…¨ä¸€æ¨£ XDï¼š 123456https://accounts.google.com/o/oauth2/v2/auth? client_id={app-id} &amp;redirect_uri=https://jyun1desu.com/login &amp;state=google &amp;response_type=code &amp;scope=email%20profile æ¯”è¼ƒéœ€è¦æ³¨æ„çš„åƒæ•¸ï¼š response_type codeï¼š è·Ÿ API ç›´æ¥å–å¾— access_token ä¸åŒï¼Œéœ€è¦èµ° server-side loginï¼šå‰ç«¯çµ¦å¾Œç«¯ code ï¼Œç”±å¾Œç«¯å»æ›å– access_tokenã€‚ tokenï¼š ç›´æ¥å–å¾— access_tokenã€‚ é›–ç„¶ç›´æ¥è¨­å®š token å¾ˆæ–¹ä¾¿ï¼Œä½†è³‡æ–™ä¸æœƒä»¥åƒæ•¸(?)ã€è€Œæ˜¯ä»¥ç¶²å€ç‰‡æ®µ(#)çš„æ–¹å¼å­˜åœ¨ã€‚è¦ºå¾—é€™æ¨£å–è³‡æ–™æœ‰é»éº»ç…©ã€ä¹Ÿæœ‰å·¥ç¨‹å¸«å»ºè­° server-side login å¾Œç«¯çš„æ¬Šé™ç®¡ç†æœƒæ¯”è¼ƒè¸å¯¦ï¼Œå°±æ±ºå®šå– code äº†ï¼ˆå¾Œç«¯äººå¾ˆå¥½ï¼‰ã€‚ redirect_uri è¦è¨˜å¾—åˆ°ç•¶åˆåœ¨ facebook developer / google cloud å»ºç«‹çš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œ æœ‰æ•ˆçš„ OAuth é‡æ–°å°å‘ URI æ–°å¢æœ‰æ•ˆç¶²å€ã€‚ä¸åœ¨åˆ—è¡¨ä¸­çš„ç¶²å€éƒ½æœƒè¢«æ“‹ä¸‹ä¾†(è·¯å¾‘ã€åƒæ•¸ä¹Ÿéƒ½è¦å¡«ä¸Š)ã€‚ å¯æ˜¯æˆ‘æƒ³é–‹å•Ÿæ–°é é¢ Ræ’‡é™¤åœ¨ in-app browser æ²’æœ‰åˆ†é åŠŸèƒ½å…ˆä¸ç†å®ƒXDï¼Œé€™å€‹æ–¹æ³•æœ€å¤§çš„ç¼ºé»æ˜¯é é¢éƒ½æœƒåœ¨åŒä¸€é è·³è½‰ï¼Œè·Ÿå¤šæ•¸ä½¿ç”¨è€…ç¿’æ…£çš„é«”é©—æ˜¯ä¸ä¸€æ¨£çš„ã€‚ä¸€é–‹å§‹æƒ³æ³•æ˜¯ï¼š in-app browser â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é ) ä¸€èˆ¬ç€è¦½å™¨ æ­£å¸¸æ¨¡å¼ â†’ ä¿ç•™ä½¿ç”¨API ç„¡ç—•æ¨¡å¼ â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é ) çµæœæ‰¾ä¸åˆ°åˆ¤æ–·ç„¡ç—•çš„å¯é æ–¹æ³•â€¦ğŸ¥² ï¼Œåªèƒ½æ”¹æˆé€™æ¨£ï¼š in-app browser â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é ) ä¸€èˆ¬ç€è¦½å™¨ â†’ æ‰‹å‹•æµç¨‹(ä¸é–‹æ–°åˆ†é â‹¯â‹¯ä½†å¥½æƒ³é–‹Rï¼ï¼ï¼) æ–¼æ˜¯é–‹å§‹æƒ³è¦æ€éº¼æ¨¡æ“¬ API é–‹å•Ÿæ–°åˆ†é ã€å‚³è³‡æ–™çµ¦éš”å£åˆ†é ã€è‡ªå‹•é—œé–‰ çš„è¡Œç‚ºï¼š é–‹å•Ÿæ–°åˆ†é ï¼šç”¨ window.open() å³å¯ XD è‡ªå‹•é—œé–‰ï¼šé€™å€‹ä¹Ÿå¾ˆç°¡å–®ï¼Œç”¨ window.close() å³å¯ XD å‚³è³‡æ–™çµ¦éš”å£åˆ†é ï¼šé€™å€‹å¥½é›£RRRRRRRï¼ï¼ï¼ï¼ï¼ ç³¾çµå¥½å¹¾å¤©å¾Œï¼ˆé€£ localStorage æ­é… visibilitychangeEvent éƒ½è©¦äº†ğŸ¥²ï¼‰ï¼Œç™¼ç¾å¾ˆè®šçš„ window.postMessage()MDNçš„è§£é‡‹å¾ˆè©³ç´° ï¼Œä»¥å‰å±…ç„¶ä¸çŸ¥é“é€™å€‹ APIï¼Œæœ¬æ¬¡æœ€å¤§æ”¶ç©«ï½ï½ï½ postMessage å¯ä»¥å¯¦ç¾åŒå€‹ç€è¦½å™¨ä¸‹çš„æºé€šï¼štabé–“ã€å½ˆå‡ºè¦–çª—èˆ‡ä¸»è¦–çª—é–“ã€ç”šè‡³å’ŒåµŒå…¥çš„ iframe ä¹Ÿå¯ä»¥ï½å¤ªæ–¹ä¾¿å•¦ï¼ä½¿ç”¨èµ·ä¾†ä¹Ÿæ»¿ç›´è§€çš„ï¼š postMessage(message, targetOrigin, transfer) messageï¼šè¦å‚³é€çš„è³‡æ–™ï¼Œå¿…å¡«ã€‚ targetOriginï¼šé™åˆ¶æ¥æ”¶å°è±¡çš„ origin ï¼Œä½¿ç”¨å­—ä¸² * å‰‡ä»£è¡¨ç„¡é™åˆ¶ï¼Œå¿…å¡«ã€‚ transferï¼šçœ‹ç„¡â€¦.ä½†å¥½åƒä¸å¤ªç”¨åˆ°ã€‚ ç›£è½ä¾†è‡ªä»–æ–¹çš„ message ä¹Ÿå¾ˆç°¡å–®ï¼šwindow.addEventListener('message', callback) ç°¡æ˜“çš„ç¯„ä¾‹åœ¨æŒ‰ä¸‹ç¬¬ä¸‰æ–¹ç™»å…¥éˆ•çš„æ™‚å€™åˆ¤æ–·æ˜¯å¦æ˜¯ in-app browser trueï¼š ä¸é–‹å•Ÿæ–°é é¢ falseï¼š é–‹å•Ÿæ–°é é¢ã€ redirect_uri å¤šè¨­å®šä¸€å€‹åƒæ•¸ï¼Œåˆ¤æ–·å›ä¾†è¦åšä¸€äº›äº‹ é»æ“Šç¬¬ä¸‰æ–¹ç™»å…¥éˆ•è§¸ç™¼ openThirdPartyAuthPageï¼š 1234567891011121314151617181920212223242526272829303132const addReciveMessageListener = () =&gt; { const reciveEvent = e =&gt; { const data = e.data if(origin === window.location.origin &amp;&amp; data.code) { doSomethingToLogin(data.code) window.removeEventListener('message', reciveEvent, false); } }; window.addEventListener('message', reciveEvent, false);};const getOAuthPageURL = (platform, isWebview) =&gt; { const redirect = isWebview? '.../login' : '.../login?type=auto-close'; switch(platform) { case 'facebook': return `https:// .....&amp;redirect_uri=${redirectUri}....`; case 'google': return `https:// .....&amp;redirect_uri=${redirectUri}....`; }}const toThirdPartyOAuthPage = platform =&gt; { const isWebview = ...; //åšä¸€äº› in-app browser çš„åˆ¤æ–· const authPageURL = getOAuthPageURL(platform, isWebview); if(isWebview){ window.location.href = authPageURL; } else { addReciveMessageListener(); window.open(authPageURL); }} è¦–çª—å›åˆ° redirect_uri å¾Œï¼Œåœ¨ route ä¸­è™•ç†ç™»å…¥è¡Œç‚ºï¼š 123456789101112131415161718// routes/Login/index.jsconst { code, type, ... } = ç¶²å€çš„query;const sendDataToLoginPage = () =&gt; { const loginData = { code }; window.opener.postMessage(loginData, 'http://jyun1desu.com');}if(code) { if(type === 'auto-close') { // normal browser redirect page sendDataToLoginPage(); window.close(); } else{ // in-app browser redirect page doSomethingToLogin(code) }} æˆåŠŸçš„æ™‚å€™å¥½æ„Ÿå‹•å•Šï½ï½ï½ ğŸ‰ğŸ‰ğŸ‰ æ‰¾è³‡æ–™çš„éç¨‹ä¸­ä¹Ÿæœ‰çœ‹åˆ° Broadcast Channel API ï¼Œé›–ç„¶æ”¯æ´åº¦é‚„å¾ˆæ‚²åŠ‡ï¼Œæ„Ÿè¦ºæ˜¯èƒ½å…ˆçœ‹èµ·ä¾†çš„æ±è¥¿ã€‚æœ€å¾Œè¬è¬ hahow ï¼Œ ä¸€åº¦è¦ºå¾—è§£æ±ºä¸äº†çš„ç„¡å¾ˆå¤šå•é¡Œï¼Œå»çœ‹äº† hahow çš„ç¶²ç«™ä¹‹å¾Œæ‰ç™¼ç¾ï¼šå—¯ï¼æœç„¶æ˜¯è‡ªå·±å¤ªæ·ºã„Œ&gt;&lt;ï¼Œå°±æ˜¯æœ‰äººåšå¾—åˆ°å•Šï¼ï¼ï¼è€Œä¸”å¯«é€™ç¯‡æ–‡ç« çš„æ™‚å€™ï¼Œçªç„¶è¦ºå¾—æ˜¯ä¸æ˜¯å…¶å¯¦æ»¿ç°¡å–®çš„â‹¯â‹¯ï¼ˆä½†ç¬¬ä¸€æ¬¡ç¢°åˆ°å°±æ˜¯è¦ºå¾—å¾ˆé›£QQï¼‰ã€‚ ä»¥ä¸Šï¼å¸Œæœ›èƒ½å¹«åŠ©åˆ°æ­£åœ¨å›°æ“¾åŒæ¨£å•é¡Œçš„äºº ğŸ‰ åƒè€ƒè³‡æ–™Google OAuthFacebook OAuthpostMessage API","link":"/2021/07/19/third-party-login/"}],"tags":[{"name":"Recoil","slug":"Recoil","link":"/tags/Recoil/"},{"name":"React","slug":"React","link":"/tags/React/"},{"name":"styled-components","slug":"styled-components","link":"/tags/styled-components/"},{"name":"ES6","slug":"ES6","link":"/tags/ES6/"},{"name":"Tagged template","slug":"Tagged-template","link":"/tags/Tagged-template/"},{"name":"ç¬¬ä¸‰æ–¹ç™»å…¥","slug":"ç¬¬ä¸‰æ–¹ç™»å…¥","link":"/tags/%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%85%A5/"},{"name":"googleç™»å…¥","slug":"googleç™»å…¥","link":"/tags/google%E7%99%BB%E5%85%A5/"},{"name":"facebookç™»å…¥","slug":"facebookç™»å…¥","link":"/tags/facebook%E7%99%BB%E5%85%A5/"}],"categories":[{"name":"JavaScript","slug":"JavaScript","link":"/categories/JavaScript/"}]}